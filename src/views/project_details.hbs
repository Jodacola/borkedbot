<html>

<head>
    <title>BorkedBot - {{project.group.name}} - {{project.name}}</title>
    <link rel="stylesheet" href="/styles.css">
    {{#if hasSnapshots}}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    {{/if}}
    {{#if autoRefresh}}
    <meta http-equiv="refresh" content="10">
    {{/if}}
</head>

<body class="bg-gray-100">
    <header class="p-4 space-y-2 bg-white border-b border-gray-200 mb-2 flex flex-row justify-between items-center">
        <div class="flex-1">
            <h1 class="text-2xl font-bold">{{project.group.name}} - {{project.name}} - Status</h1>
            <a href="/groups/{{project.group.externalId}}" class="inline-flex flex-row items-center gap-1 px-3 py-1 border-blue-300 border-1 rounded-md text-blue-500 hover:text-blue-700 text-xs"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                </svg> All {{project.group.name}} projects</a>
        </div>
        <div>
            {{#if this.autoRefresh}}
            <a class="inline-flex flex-row items-center gap-1 px-3 py-1 border-gray-300 border-1 rounded-md text-xs" href="/projects/{{project.externalId}}?refresh=false&page={{snapshots.page}}"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 inline-block stroke-green-500">
  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
</svg> Auto-refresh (enabled)</a>
            {{else}}
            <a class="inline-flex flex-row items-center gap-1 px-3 py-1 border-gray-300 border-1 rounded-md text-xs" href="/projects/{{project.externalId}}?refresh=true&page={{snapshots.page}}"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 inline-block stroke-red-500">
  <path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
</svg> Auto-refresh (disabled)</a>
            {{/if}}
        </div>
    </header>
    <main>
        <div
            class="sm:flex sm:flex-row sm:justify-between space-y-2 sm:space-y-0 sm:space-x-4 p-4 m-4 bg-white rounded-lg border border-gray-200">
            <div>
                <h2 class="text-xs font-bold text-gray-400">Project</h2>
                <p>{{project.name}}</p>
            </div>
            <div>
                <h2 class="text-xs font-bold text-gray-400">Project URL</h2>
                <a class="text-blue-500 hover:text-blue-700" href="{{project.url}}" target="_blank">{{project.url}}</a>
            </div>
            <div>
                <h2 class="text-xs font-bold text-gray-400">Default Branch</h2>
                <a class="text-blue-500 hover:text-blue-700"
                    href="{{project.url}}/commits/{{project.defaultBranchName}}"
                    target="_blank">{{project.defaultBranchName}}</a>
            </div>
        </div>
        <div class="p-4 m-4 bg-white rounded-lg border border-gray-200">
            <h2 class="text-lg font-bold pb-2">Trends <a href="#trends" class="inline-block ml-1" name="trends"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="inline-block size-4 stroke-gray-400 hover:stroke-gray-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" />
                </svg></a>
            </h2>
            {{#if hasSnapshots}}
            <div class="w-full h-64">
                <canvas id="trendsChart"></canvas>
            </div>
            {{#if hasAnyOlderOrNewerSnapshots}}
            <div class="flex flex-row justify-between">
            {{#if hasOlderSnapshots}}
            <a href="/projects/{{project.externalId}}?page={{olderSnapshotsPage}}&refresh={{autoRefresh}}" class="inline-flex flex-row items-center gap-1 px-3 py-1 border-blue-300 border-1 rounded-md text-blue-500 hover:text-blue-700 text-xs"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4 inline-block">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
            </svg> Older trends</a>
            {{else}}
            <a href="#" aria-disabled="true" class="inline-flex flex-row items-center gap-1 px-3 py-1 border-gray-300 border-1 rounded-md text-gray-300 cursor-default text-xs"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4 inline-block">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
            </svg> Older trends</a>
            {{/if}}
            {{#if hasNewerSnapshots}}
            <a href="/projects/{{project.externalId}}?page={{newerSnapshotsPage}}&refresh={{autoRefresh}}" class="inline-flex flex-row items-center gap-1 px-3 py-1 border-blue-300 border-1 rounded-md text-blue-500 hover:text-blue-700 text-xs">Newer trends <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4 inline-block">
                <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
            </svg></a>
            {{else}}
            <a href="#" aria-disabled="true" class="inline-flex flex-row items-center gap-1 px-3 py-1 border-gray-300 border-1 rounded-md text-gray-300 cursor-default text-xs">Newer trends <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4 inline-block">
                <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
            </svg></a>
            {{/if}}
            </div>
            {{/if}}
            {{else}}
            <p class="text-gray-300 text-sm">Historical data not yet available.</p>
            {{/if}}
        </div>
        <div class="p-4 m-4 bg-white rounded-lg border border-gray-200">
            <h2 class="text-lg font-bold pb-2">Open Failing PRs <a href="#failingPrs" class="inline-block ml-1" name="failingPrs"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="inline-block size-4 stroke-gray-400 hover:stroke-gray-600">
  <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" />
</svg></a></h2>
            {{#unless hasFailingPrs}}
                <p class="text-gray-300 text-sm">There are currently no failing PRs.</p>
            {{/unless}}
            <table class="w-full">
                <tbody>
                    {{#each this.failingPrs}}
                    <tr class="hover:bg-gray-100 transition-colors duration-300">
                        <td class="pl-2 align-top py-1">
                            <a href="{{../project.url}}/pull/{{this.number}}" target="_blank"
                                class="text-blue-500 hover:text-blue-700 text-sm font-black">
                                #{{this.number}}
                            </a>
                        </td>
                        <td class="pl-2 py-1">
                            <a href="{{../project.url}}/pull/{{this.number}}" target="_blank"
                                class="text-blue-500 hover:text-blue-700 text-sm">
                                {{this.title}}
                            </a>
                        </td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>
    </main>
    <footer class="p-4 text-center text-gray-300 text-sm"><a href="https://github.com/Jodacola/borkedbot"
            target="_blank">BorkedBot Open
            Source Project</a></footer>

    {{#if hasSnapshots}}
    <script>
        // Prepare chart data from snapshots
        const snapshots = [
            {{#each snapshots.snapshots}}
            {
                id: "{{this.id}}",
                createdAt: new Date("{{this.createdAt}}"),
                numberOfPrs: {{this.numberOfPrs}},
                numberOfFailedPrs: {{this.numberOfFailedPrs}}
            }{{#unless @last}},{{/unless}}
            {{/each}}
        ];
        
        // Sort snapshots by createdAt timestamp
        const sortedSnapshots = snapshots.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
        
        const chartData = {
            labels: sortedSnapshots.map(s => {
                const date = new Date(s.createdAt);
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                let hour = date.getHours();
                const minute = String(date.getMinutes()).padStart(2, '0');
                const ampm = hour >= 12 ? 'PM' : 'AM';
                hour = hour % 12;
                hour = hour ? hour : 12; // the hour '0' should be '12'
                return `${month}/${day} ${hour}:${minute} ${ampm}`;
            }),
            datasets: [
                {
                    label: 'Failing PRs',
                    data: sortedSnapshots.map(s => s.numberOfFailedPrs),
                    backgroundColor: 'rgba(239, 68, 68, 0.6)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 1,
                    fill: true
                },
                {
                    label: 'Passing/Pending PRs',
                    data: sortedSnapshots.map(s => s.numberOfPrs - s.numberOfFailedPrs),
                    backgroundColor: 'rgba(34, 197, 94, 0.6)',
                    borderColor: 'rgba(34, 197, 94, 1)',
                    borderWidth: 1,
                    fill: true
                }
            ]
        };

        // Create stacked area chart
        const ctx = document.getElementById('trendsChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Time',
                            font: {
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            maxRotation: 90,
                            minRotation: 90,
                            font: {
                                size: 8
                            }
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of PRs',
                            font: {
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            font: {
                                size: 8
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            footer: function (context) {
                                let sum = 0;

                                context.forEach(function (tooltipItem) {
                                    sum += tooltipItem.parsed.y;
                                });

                                return "Total PRs: " + sum;
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    </script>
    {{/if}}
</html>